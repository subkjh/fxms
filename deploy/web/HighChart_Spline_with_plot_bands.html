<!DOCTYPE html>
<html>
<head lang="en">
<meta charset="UTF-8">
<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>

<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/series-label.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>

<script src="js/fxms.js"></script>

<script>
	$(document).ready(
			
			function() {
				
				var userId = window.localStorage.getItem("FXMSTEST.user.id");
				var userPwd = window.localStorage.getItem("FXMSTEST.user.pwd");
				
				let fxms = new FxMS(userId, userPwd, function() {
					showPsValue();
				});

				function showPsValue() {
					fxms.call('ps/select-ps-value-list', {
						moNo : 0,
						psId : 'ePower',
						psDataCd : 'HOUR1',
						psStatFuncList : 'AVG',
						startPsDate : DateUtil.getDtm(-86400000 * 21),
						endPsDate : DateUtil.getDtm()

					}, displayGrid);

				}

				function displayGrid(isOk, result) {

					console.log(result);

					if (isOk) {

						var data;
						var series = [];
						var valueList;
						var psItem;
						var minDtm = 99999999000000;

						for (var n = 0; n < result.length; n++) {
							valueList = result[n].valueList;
							psItem = result[n].psItem;

							data = [];
							for (var i = 0; i < valueList.length; i++) {

								valueList[i][0] = DateUtil.makeDate(
										valueList[i][0]).getTime();

								if (valueList[i][0] < minDtm) {
									minDtm = valueList[i][0];
								}

								data
										.push(parseFloat(valueList[i][1]
												.toFixed(3)));

							}

							series.push({
								name : result[n].mo.moName,
								data : data
							});

						}
						console.log(minDtm, new Date(minDtm), Date.UTC(2018, 1,
								13, 0, 0, 0));

						makeChart(series, psItem, minDtm);

					} else {
						alert(result);
					}

				}

				// 사용자가 입력한 메시지를 서버로 전송한다.
				function sendMessage() {
					var txtSend = $('#Send');

					ws.send(txtSend.val());
					txtSend.val("");
				}

				function makeChart(series, psItem, minDate) {

					// 로컬 시간 사용
					Highcharts.setOptions({
						global : {
							useUTC : false
						}
					});

					// datas는 [ [ 일자, 값], [일자, 값] ... ] 형식이다.

					Highcharts.chart('container', {
						chart : {
							type : 'spline',
							scrollablePlotArea : {
								minWidth : 600,
								scrollPositionX : 1
							}
						},
						title : {
							text : 'VUP 전력(KW) 추이',
							align : 'left'
						},
						subtitle : {
							text : '안산 전력 사용 추이',
							align : 'left'
						},
						xAxis : {
							type : 'datetime',
							labels : {
								overflow : 'justify'
							}
						},
						yAxis : {
							title : {
								text : psItem.psUnit.dispText
							},
							minorGridLineWidth : 0,
							gridLineWidth : 0,
							alternateGridColor : null,
							plotBands : [ { // Light air
								from : 0.3,
								to : 1.5,
								color : 'rgba(68, 170, 213, 0.1)',
								label : {
									text : 'Light air',
									style : {
										color : '#606060'
									}
								}
							}, { // Light breeze
								from : 1.5,
								to : 3.3,
								color : 'rgba(0, 0, 0, 0)',
								label : {
									text : 'Light breeze',
									style : {
										color : '#606060'
									}
								}
							}, { // Gentle breeze
								from : 3.3,
								to : 5.5,
								color : 'rgba(68, 170, 213, 0.1)',
								label : {
									text : 'Gentle breeze',
									style : {
										color : '#606060'
									}
								}
							}, { // Moderate breeze
								from : 150,
								to : 200,
								color : 'rgba(0, 0, 0, 0)',
								label : {
									text : 'Moderate breeze',
									style : {
										color : '#606060'
									}
								}
							}, { // Fresh breeze
								from : 200,
								to : 300,
								color : 'rgba(68, 170, 213, 0.1)',
								label : {
									text : 'Fresh breeze',
									style : {
										color : '#606060'
									}
								}
							}, { // Strong breeze
								from : 300,
								to : 400,
								color : 'rgba(0, 0, 0, 0)',
								label : {
									text : 'Strong breeze',
									style : {
										color : '#606060'
									}
								}
							}, { // High wind
								from : 400,
								to : 450,
								color : 'rgba(68, 170, 213, 0.1)',
								label : {
									text : 'High wind',
									style : {
										color : '#606060'
									}
								}
							} ]
						},
						tooltip : {
							valueSuffix : ' ' + psItem.psUnit.dispText
						},
						plotOptions : {
							spline : {
								lineWidth : 4,
								states : {
									hover : {
										lineWidth : 5
									}
								},
								marker : {
									enabled : false
								},
								pointInterval : 3600000 * 3, // one hour
								pointStart : minDate
							// Date.UTC(2018, 1, 13, 0, 0, 0)
							}
						},

						// 데이터
						series : series,

						navigation : {
							menuItemStyle : {
								fontSize : '10px'
							}
						}
					});

				}
			});
</script>


<style>
.highcharts-figure, .highcharts-data-table table {
	min-width: 310px;
	max-width: 800px;
	margin: 1em auto;
}

.highcharts-data-table table {
	font-family: Verdana, sans-serif;
	border-collapse: collapse;
	border: 1px solid #ebebeb;
	margin: 10px auto;
	text-align: center;
	width: 100%;
	max-width: 500px;
}

.highcharts-data-table caption {
	padding: 1em 0;
	font-size: 1.2em;
	color: #555;
}

.highcharts-data-table th {
	font-weight: 600;
	padding: 0.5em;
}

.highcharts-data-table td, .highcharts-data-table th,
	.highcharts-data-table caption {
	padding: 0.5em;
}

.highcharts-data-table thead tr, .highcharts-data-table tr:nth-child(even)
	{
	background: #f8f8f8;
}

.highcharts-data-table tr:hover {
	background: #f1f7ff;
}
</style>

</head>
<body>
	<h2>HighChart Spline Plot</h2>

	<div id="Recv"></div>
	<figure class="highcharts-figure">
		<div id="container"></div>
		<p class="highcharts-description"></p>
	</figure>
</body>
</html>